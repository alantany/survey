<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>问卷调查AI小助手</title>
    <style>
        /* 参考 survey-assistant-ui 的视觉风格：圆角更大、玻璃拟态卡片、柔和渐变背景、主色 indigo */
        :root {
            /* 更贴近 survey-assistant-ui 的蓝色系（避免偏紫） */
            --bg-0: #eff6ff;
            --bg-1: #eef2ff;
            --bg-2: #f5f3ff;
            --foreground: #111827;
            --muted-foreground: #6b7280;
            --card: rgba(255, 255, 255, 0.72);
            --border: rgba(255, 255, 255, 0.55);
            --border-strong: rgba(17, 24, 39, 0.10);
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --primary-foreground: #ffffff;
            --success: #22c55e;
            --success-bg: rgba(34, 197, 94, 0.10);
            --radius: 22px;
            --shadow-lg: 0 24px 70px rgba(15, 23, 42, 0.18);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--bg-0) 0%, var(--bg-1) 45%, var(--bg-2) 100%);
            color: var(--foreground);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 22px;
        }
        .page-shell {
            width: 100%;
            max-width: 1200px;
            display: grid;
            grid-template-columns: 280px minmax(0, 1fr) 280px;
            gap: 24px;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: calc(var(--radius) + 6px);
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            overflow: hidden;
            padding: 34px;
        }

        .side-card {
            /* 对齐 survey-assistant-ui：backdrop-blur-md bg-white/40 rounded-3xl p-6 border border-white/60 shadow-lg */
            background: rgba(255, 255, 255, 0.40);
            border: 1px solid rgba(255, 255, 255, 0.60);
            border-radius: 24px;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 18px 44px rgba(15, 23, 42, 0.10);
            padding: 24px;
        }

        .side-title {
            font-size: 13px;
            font-weight: 700;
            color: rgba(17, 24, 39, 0.80);
            letter-spacing: 0.08em;
            text-transform: uppercase;
            margin-bottom: 16px;
        }

        .side-list {
            list-style: none;
            padding-left: 0;
            margin: 0;
            display: grid;
            gap: 16px;
        }

        .side-step {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .side-badge {
            width: 28px;
            height: 28px;
            border-radius: 999px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.20) 0%, rgba(99, 102, 241, 0.20) 100%);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: background 0.2s ease;
        }

        .side-badge span {
            font-size: 12px;
            font-weight: 700;
            color: var(--primary);
        }

        .side-step-body {
            min-width: 0;
            flex: 1;
        }

        .side-step-title {
            font-size: 14px;
            font-weight: 650;
            color: rgba(17, 24, 39, 0.92);
            margin: 0 0 2px 0;
        }

        .side-step-desc {
            font-size: 12px;
            color: rgba(107, 114, 128, 1);
            line-height: 1.6;
            margin: 0;
        }

        .side-foot {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.40);
        }

        .side-foot-text {
            font-size: 12px;
            color: rgba(107, 114, 128, 1);
            line-height: 1.6;
            margin: 0;
        }

        .title-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 42px;
        }

        /* 顶部标题与第一步之间：很淡的分割线（用于轻微区分区域，不破坏整体简洁） */
        .header-divider{
            margin: 18px 0 26px;
            border: none;
            height: 1px;
            background: linear-gradient(90deg,
              rgba(59,130,246,0) 0%,
              rgba(17,24,39,0.05) 18%,
              rgba(17,24,39,0.08) 50%,
              rgba(17,24,39,0.05) 82%,
              rgba(59,130,246,0) 100%
            );
        }

        .title-icon {
            width: 34px;
            height: 34px;
            color: rgba(17, 24, 39, 0.65);
        }

        h1 {
            text-align: center;
            color: var(--foreground);
            font-size: 34px;
            font-weight: 650;
            letter-spacing: -0.02em;
            margin-bottom: 0;
        }

        /* 只隐藏“音频上传”的文件输入框（LLM 匹配区的 txt 选择需要显示） */
        #fileInput {
            display: none;
        }

        .status {
            text-align: center;
            padding: 12px 14px;
            margin-bottom: 12px;
            border-radius: 18px;
            display: none;
            border: 1px solid var(--border-strong);
            background: rgba(255, 255, 255, 0.65);
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
        }

        .status.info {
            color: #1d4ed8;
            background: rgba(59, 130, 246, 0.10);
            border-color: rgba(59, 130, 246, 0.20);
        }

        .status.success {
            color: #166534;
            background: var(--success-bg);
            border-color: rgba(34, 197, 94, 0.25);
        }

        .status.error {
            background: rgba(239, 68, 68, 0.10);
            color: #b91c1c;
            border: 2px solid rgba(239, 68, 68, 0.35);
            font-weight: 600;
            position: relative;
        }

        .status.error::after {
            content: ' ✕ 点击关闭';
            font-size: 12px;
            opacity: 0.75;
            margin-left: 10px;
        }

        .upload-area {
            border: 2px dashed rgba(99, 102, 241, 0.35);
            border-radius: 26px;
            padding: 44px 22px;
            text-align: center;
            margin: 18px 0 18px;
            cursor: pointer;
            transition: all 0.25s ease;
            background: rgba(99, 102, 241, 0.06);
        }

        .upload-area:hover {
            border-color: rgba(79, 70, 229, 0.55);
            background: rgba(99, 102, 241, 0.10);
            transform: translateY(-1px);
        }

        .upload-area.dragover {
            border-color: rgba(79, 70, 229, 0.75);
            background: rgba(79, 70, 229, 0.12);
        }

        .upload-icon {
            width: 74px;
            height: 74px;
            border-radius: 20px;
            margin: 0 auto 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(219, 234, 254, 0.95) 0%, rgba(224, 231, 255, 0.95) 60%);
            box-shadow: 0 12px 26px rgba(15, 23, 42, 0.10);
        }

        .upload-icon svg {
            width: 34px;
            height: 34px;
            color: rgba(37, 99, 235, 0.95);
        }

        .upload-text {
            color: var(--foreground);
            font-size: 15px;
            line-height: 1.4;
        }

        .upload-text.subtle {
            color: var(--muted-foreground);
            font-size: 12px;
            margin-top: 6px;
        }

        .audio-player {
            margin: 18px 0 10px;
            display: none;
        }

        .audio-player audio {
            width: 100%;
            outline: none;
        }

        .mode-row {
            margin-bottom: 16px;
            padding: 12px 14px;
            background: rgba(99, 102, 241, 0.06);
            border: 1px solid rgba(99, 102, 241, 0.16);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .mode-label {
            font-size: 13px;
            color: var(--foreground);
            font-weight: 650;
        }

        .segmented {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            padding: 6px;
            background: rgba(17, 24, 39, 0.05);
            border-radius: 16px;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.65);
        }

        .segmented label {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            border-radius: 12px;
            overflow: hidden;
        }

        .segmented input[type="radio"] {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .segmented span {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 650;
            color: rgba(17, 24, 39, 0.72);
            transition: all 0.2s ease;
            user-select: none;
        }

        .segmented label:hover span {
            color: rgba(17, 24, 39, 0.92);
        }

        .segmented input[type="radio"]:checked + span {
            background: linear-gradient(180deg, rgba(96, 165, 250, 1) 0%, var(--primary) 100%);
            color: var(--primary-foreground);
            box-shadow: 0 10px 22px rgba(59, 130, 246, 0.26);
        }

        .button-group {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
            margin: 18px 0 14px;
        }

        .button-group-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        button {
            height: 54px;
            padding: 12px 18px;
            border: none;
            border-radius: 20px;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 650;
            letter-spacing: -0.01em;
        }

        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.85;
        }

        .btn-primary {
            background: linear-gradient(180deg, rgba(96, 165, 250, 1) 0%, var(--primary) 100%);
            color: var(--primary-foreground);
            box-shadow: 0 12px 26px rgba(59, 130, 246, 0.28);
        }

        .btn-primary:hover {
            background: linear-gradient(180deg, rgba(96, 165, 250, 1) 0%, var(--primary-hover) 100%);
            transform: translateY(-1px);
            box-shadow: 0 16px 34px rgba(59, 130, 246, 0.32);
        }

        .btn-primary:disabled {
            background: rgba(17, 24, 39, 0.18);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.55);
            color: var(--foreground);
            border: 1px solid rgba(17, 24, 39, 0.10);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.80);
            transform: translateY(-1px);
        }

        /* 转写结果区的三个动作按钮：更接近设计稿的“胶囊 + 细边框 + 轻阴影” */
        .action-btn {
            background: rgba(255, 255, 255, 0.82);
            border: 1px solid rgba(17, 24, 39, 0.12);
            box-shadow: 0 10px 22px rgba(15, 23, 42, 0.08);
            font-weight: 700;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(59, 130, 246, 0.22);
            box-shadow: 0 14px 28px rgba(15, 23, 42, 0.10);
        }

        .action-btn:disabled {
            opacity: 0.55;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .result-area {
            margin-top: 18px;
            display: none;
        }

        .result-label {
            font-weight: 750;
            color: var(--foreground);
            margin-bottom: 10px;
            font-size: 18px;
        }

        /* 功能分区标题：图标 + 标题 + 一行说明（与 AI 匹配区保持一致风格） */
        .section-title {
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            width: 22px;
            height: 22px;
            color: rgba(17, 24, 39, 0.65);
        }

        .section-subtitle {
            font-size: 13px;
            margin: 12px 0 16px;
            color: #666;
            line-height: 1.6;
        }

        .result-text {
            background: rgba(255, 255, 255, 0.60);
            border: 1px solid rgba(17, 24, 39, 0.10);
            border-radius: 18px;
            padding: 16px 18px;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
            color: var(--foreground);
            line-height: 1.75;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .section-divider {
            margin: 26px 0;
            border: none;
            height: 1px;
            /* 更清晰但不突兀：中间略亮、两侧淡出的渐变分割线 */
            background: linear-gradient(
                90deg,
                rgba(59, 130, 246, 0) 0%,
                rgba(59, 130, 246, 0.22) 18%,
                rgba(59, 130, 246, 0.38) 50%,
                rgba(59, 130, 246, 0.22) 82%,
                rgba(59, 130, 246, 0) 100%
            );
        }

        .two-inputs {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        .file-input {
            padding: 12px 14px;
            border: 1px solid rgba(17, 24, 39, 0.12);
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.60);
        }

        /* LLM 匹配区：卡片式文件选择器（保留原 input id，JS 仍读取 input.files） */
        .file-select input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 1px;
            height: 1px;
            pointer-events: none;
        }

        .file-select-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 14px 16px;
            border-radius: 18px;
            background: rgba(255, 255, 255, 0.60);
            border: 1px solid rgba(17, 24, 39, 0.10);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-select-label:hover {
            background: rgba(255, 255, 255, 0.80);
            transform: translateY(-1px);
        }

        .file-select-title {
            font-size: 12px;
            font-weight: 650;
            color: rgba(17, 24, 39, 0.55);
            margin-bottom: 2px;
        }

        .file-select-name {
            font-size: 14px;
            font-weight: 650;
            color: rgba(17, 24, 39, 0.85);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 320px;
        }

        .file-select-icon {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: rgba(17, 24, 39, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .file-select-icon svg {
            width: 20px;
            height: 20px;
            color: rgba(107, 114, 128, 1);
        }

        @media (max-width: 720px) {
            .container { padding: 22px; }
            h1 { font-size: 28px; }
            .button-group { grid-template-columns: 1fr; }
            .button-group-3 { grid-template-columns: 1fr; }
            .two-inputs { grid-template-columns: 1fr; }
            button { height: 52px; }
        }

        @media (max-width: 1100px) {
            .page-shell {
                grid-template-columns: 1fr;
                max-width: 920px;
            }
            .side-card {
                display: none;
            }
            .container {
                max-width: 920px;
            }
        }
    </style>
</head>
<body>
    <div class="page-shell">
        <aside class="side-card" aria-label="使用指南">
            <div class="side-title">1.音频转文本</div>
            <ul class="side-list">
                <li class="side-step">
                    <div class="side-badge"><span>1</span></div>
                    <div class="side-step-body">
                        <p class="side-step-title">上传音频</p>
                        <p class="side-step-desc">点击或拖拽音频文件</p>
                    </div>
                </li>
                <li class="side-step">
                    <div class="side-badge"><span>2</span></div>
                    <div class="side-step-body">
                        <p class="side-step-title">选择模式</p>
                        <p class="side-step-desc">本地转写或在线转写</p>
                    </div>
                </li>
                <li class="side-step">
                    <div class="side-badge"><span>3</span></div>
                    <div class="side-step-body">
                        <p class="side-step-title">开始转文字</p>
                        <p class="side-step-desc">等待完成后查看结果</p>
                    </div>
                </li>
                <li class="side-step">
                    <div class="side-badge"><span>4</span></div>
                    <div class="side-step-body">
                        <p class="side-step-title">格式化文本</p>
                        <p class="side-step-desc">自动整理为采访对话</p>
                    </div>
                </li>
                <li class="side-step">
                    <div class="side-badge"><span>5</span></div>
                    <div class="side-step-body">
                        <p class="side-step-title">下载结果</p>
                        <p class="side-step-desc">导出生成的文本</p>
                    </div>
                </li>
            </ul>
        </aside>

        <div class="container">
        <div class="title-row">
            <svg class="title-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12.5 6.5l5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                <path d="M4 20h4l10.5-10.5a2.1 2.1 0 0 0 0-3L16.5 4.5a2.1 2.1 0 0 0-3 0L3 15v5z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
            <h1>问卷调查AI小助手</h1>
        </div>

        <hr class="header-divider" />
        
        <div id="status" class="status"></div>

        <div class="result-label">
            <span class="section-title">
                <svg class="section-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M19 11a7 7 0 0 1-14 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M12 18v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M8 21h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span>第一步：语音转文字</span>
            </span>
        </div>
        <div class="section-subtitle">上传音频并转写为文本；完成后可格式化为对话并下载结果。</div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                    <path d="M12 3v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M8 7l4-4 4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M4 14v5a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </div>
            <div class="upload-text">点击或拖拽音频文件到这里</div>
            <div class="upload-text subtle">支持 MP3, WAV, OGG 等格式</div>
        </div>
        <input type="file" id="fileInput" accept="audio/*">

        <div class="audio-player" id="audioPlayer">
            <audio id="audioElement" controls></audio>
        </div>

        <div class="mode-row">
            <div class="mode-label">转写模式：</div>
            <div class="segmented">
                <label>
                    <input type="radio" name="transcribeMode" value="local" checked>
                    <span>本地转写</span>
                </label>
                <label>
                    <input type="radio" name="transcribeMode" value="api">
                    <span>在线转写</span>
                </label>
            </div>
        </div>

        <div class="button-group">
            <button class="btn-primary" id="transcribeBtn" disabled>开始转文字</button>
            <button class="btn-secondary" id="clearBtn">清空</button>
        </div>

        <div style="display:none;">
            <!-- 历史功能：docx bundle（已隐藏，避免用户误以为只能选 docx） -->
            <button class="btn-secondary" id="bundleBtn" disabled>导出给LLM（docx+文本）</button>
            <input type="file" id="docxInput" accept=".docx" />
        </div>

        <div class="result-area" id="resultArea">
            <div class="result-label">转换结果：</div>
            <div class="result-text" id="resultText"></div>
            <div class="button-group button-group-3" style="margin-top: 10px;">
                <button class="btn-secondary action-btn" id="formatTranscriptBtn" disabled>格式化文本</button>
                <button class="btn-secondary action-btn" id="copyTranscriptBtn" disabled>复制文本</button>
                <button class="btn-secondary action-btn" id="downloadTranscriptBtn" disabled>下载结果</button>
            </div>
        </div>

        <hr class="section-divider" />

        <div class="result-label">
            <span class="section-title">
                <svg class="section-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M12 2l1.2 3.6a2 2 0 0 0 1.26 1.26L18 8l-3.54 1.14a2 2 0 0 0-1.26 1.26L12 14l-1.2-3.6a2 2 0 0 0-1.26-1.26L6 8l3.54-1.14A2 2 0 0 0 10.8 5.6L12 2z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
                    <path d="M18.5 12.5l.7 2.1a1.2 1.2 0 0 0 .76.76l2.04.64-2.04.64a1.2 1.2 0 0 0-.76.76l-.7 2.1-.7-2.1a1.2 1.2 0 0 0-.76-.76L15.3 16l2.04-.64a1.2 1.2 0 0 0 .76-.76l.4-1.1z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
                </svg>
                <span>第二步：AI智能匹配</span>
            </span>
        </div>
        <div class="section-subtitle">
            <b>选择结果文件</b>和<b>问题模版文件</b>，点击开始匹配。
        </div>

        <div class="two-inputs">
            <div class="file-select">
                <input id="transcriptTxtInput" type="file" accept=".txt">
                <label class="file-select-label" for="transcriptTxtInput">
                    <div style="min-width:0;">
                        <div class="file-select-title">选择文件</div>
                        <div class="file-select-name" id="transcriptTxtName">未选择文件</div>
                    </div>
                    <div class="file-select-icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none">
                            <path d="M12 3v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <path d="M8 7l4-4 4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M4 14v5a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                </label>
            </div>
            <div class="file-select">
                <input id="questionsTxtInput" type="file" accept=".txt">
                <label class="file-select-label" for="questionsTxtInput">
                    <div style="min-width:0;">
                        <div class="file-select-title">选择文件</div>
                        <div class="file-select-name" id="questionsTxtName">未选择文件</div>
                    </div>
                    <div class="file-select-icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none">
                            <path d="M12 3v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <path d="M8 7l4-4 4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M4 14v5a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                </label>
            </div>
        </div>

        <div class="button-group">
            <button class="btn-primary" id="runMatchBtn">开始匹配</button>
            <button class="btn-secondary" id="downloadMatchBtn" disabled>下载结果</button>
        </div>

        <div class="result-area" id="matchArea" style="display:none;">
            <div class="result-label">匹配结果：</div>
            <div class="result-text" id="matchText"></div>
        </div>
        </div>

        <aside class="side-card" aria-label="AI 匹配指南">
            <div class="side-title">2.问题智能匹配</div>
            <ul class="side-list">
                <li class="side-step">
                    <div class="side-badge"><span>1</span></div>
                    <div class="side-step-body">
                        <p class="side-step-title">选择结果文件</p>
                        <p class="side-step-desc">转写格式化后的 .txt</p>
                    </div>
                </li>
                <li class="side-step">
                    <div class="side-badge"><span>2</span></div>
                    <div class="side-step-body">
                        <p class="side-step-title">选择问题模板</p>
                        <p class="side-step-desc">问卷模板文件</p>
                    </div>
                </li>
                <li class="side-step">
                    <div class="side-badge"><span>3</span></div>
                    <div class="side-step-body">
                        <p class="side-step-title">开始匹配</p>
                        <p class="side-step-desc">等待模型输出完成</p>
                    </div>
                </li>
                <li class="side-step">
                    <div class="side-badge"><span>4</span></div>
                    <div class="side-step-body">
                        <p class="side-step-title">下载结果</p>
                        <p class="side-step-desc">保存匹配后的文本</p>
                    </div>
                </li>
            </ul>
            <div class="side-foot">
                <p class="side-foot-text"></p>
            </div>
        </aside>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const audioPlayer = document.getElementById('audioPlayer');
        const audioElement = document.getElementById('audioElement');
        const transcribeBtn = document.getElementById('transcribeBtn');
        const clearBtn = document.getElementById('clearBtn');
        const bundleBtn = document.getElementById('bundleBtn');
        const docxInput = document.getElementById('docxInput');
        const resultArea = document.getElementById('resultArea');
        const resultText = document.getElementById('resultText');
        const formatTranscriptBtn = document.getElementById('formatTranscriptBtn');
        const copyTranscriptBtn = document.getElementById('copyTranscriptBtn');
        const downloadTranscriptBtn = document.getElementById('downloadTranscriptBtn');
        const status = document.getElementById('status');
        const transcriptTxtInput = document.getElementById('transcriptTxtInput');
        const questionsTxtInput = document.getElementById('questionsTxtInput');
        const transcriptTxtName = document.getElementById('transcriptTxtName');
        const questionsTxtName = document.getElementById('questionsTxtName');
        const runMatchBtn = document.getElementById('runMatchBtn');
        const downloadMatchBtn = document.getElementById('downloadMatchBtn');
        const matchArea = document.getElementById('matchArea');
        const matchText = document.getElementById('matchText');

        let audioFile = null;
        let currentJobId = null;
        let pollTimer = null;
        let backendReady = false;
        let lastLog = '';
        let lastMatchContent = '';
        let matchLoadingTimer = null;
        let matchLoadingDots = 0;

        function getTranscriptText() {
            return String(resultText.textContent || '').trim();
        }

        function setTranscriptActionsEnabled(enabled) {
            formatTranscriptBtn.disabled = !enabled;
            copyTranscriptBtn.disabled = !enabled;
            downloadTranscriptBtn.disabled = !enabled;
        }

        async function copyToClipboard(text) {
            const t = String(text || '');
            if (!t) return;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(t);
                return;
            }
            // fallback
            const ta = document.createElement('textarea');
            ta.value = t;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            ta.style.top = '0';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            document.execCommand('copy');
            ta.remove();
        }

        function downloadTextAsFile(text, filename) {
            const blob = new Blob([String(text || '')], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        // 显示状态信息
        let statusTimer = null;
        function showStatus(message, type) {
            // 清除之前的定时器
            if (statusTimer) {
                clearTimeout(statusTimer);
                statusTimer = null;
            }
            
            status.textContent = message;
            status.className = 'status ' + type;
            status.style.display = 'block';
            
            // 错误信息不自动消失，其他信息 5 秒后消失
            if (type === 'error') {
                // 错误信息保持显示，用户可以手动关闭或等待下一个状态覆盖
                // 添加点击关闭功能
                status.style.cursor = 'pointer';
                status.title = '点击关闭';
                status.onclick = function() {
                    status.style.display = 'none';
                };
            } else {
                // 成功和信息提示 5 秒后自动消失
                status.style.cursor = 'default';
                status.onclick = null;
                statusTimer = setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }

        function stopPolling() {
            if (pollTimer) {
                clearInterval(pollTimer);
                pollTimer = null;
            }
            currentJobId = null;
        }

        async function checkBackend() {
            try {
                const resp = await fetch('/api/health', { method: 'GET' });
                if (!resp.ok) throw new Error('health not ok');
                backendReady = true;
                showStatus('本地服务已连接（离线转写模式）', 'success');
            } catch (e) {
                backendReady = false;
                transcribeBtn.disabled = true;
                bundleBtn.disabled = true;
                showStatus('未检测到本地服务：请先运行 python backend/app.py，再用 http://127.0.0.1:8000 打开本页面', 'error');
            }
        }

        // 点击上传区域
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // 拖拽上传
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // 文件选择
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // 处理文件
        function handleFile(file) {
            if (!file.type.startsWith('audio/')) {
                showStatus('请选择音频文件', 'error');
                return;
            }

            audioFile = file;
            const url = URL.createObjectURL(file);
            audioElement.src = url;
            audioPlayer.style.display = 'block';
            transcribeBtn.disabled = !backendReady ? true : false;
            bundleBtn.disabled = true;
            setTranscriptActionsEnabled(false);
            resultText.textContent = '';
            resultArea.style.display = 'none';
            showStatus('文件已加载，点击“开始转文字”上传并离线转写（1小时音频可能需要较长时间）', 'info');
        }

        // 开始转文字
        transcribeBtn.addEventListener('click', async () => {
            if (!backendReady) {
                showStatus('本地服务未就绪：请先运行 python backend/app.py', 'error');
                return;
            }
            if (!audioFile) {
                showStatus('请先上传音频文件', 'error');
                return;
            }

            stopPolling();
            resultText.textContent = '';
            resultArea.style.display = 'block';
            setTranscriptActionsEnabled(false);

            try {
                transcribeBtn.disabled = true;
                transcribeBtn.textContent = '上传中...';
                showStatus('开始上传音频（大文件可能需要一会儿）...', 'info');

                const form = new FormData();
                form.append('file', audioFile, audioFile.name);
                // 获取转写模式
                const modeRadio = document.querySelector('input[name="transcribeMode"]:checked');
                const mode = modeRadio ? modeRadio.value : 'local';
                form.append('mode', mode);

                const resp = await fetch('/api/transcribe', {
                    method: 'POST',
                    body: form
                });
                const data = await resp.json().catch(() => ({}));
                if (!resp.ok) {
                    const msg = data && data.error ? data.error : '提交任务失败';
                    throw new Error(msg);
                }
                currentJobId = data.job_id;
                transcribeBtn.textContent = '转写中...';
                bundleBtn.disabled = true;
                showStatus('已提交转写任务，处理中…（可切到后台等待）', 'info');

                pollTimer = setInterval(async () => {
                    try {
                        const jr = await fetch(`/api/jobs/${currentJobId}`, { method: 'GET' });
                        const jd = await jr.json().catch(() => ({}));
                        if (!jr.ok) throw new Error(jd && jd.error ? jd.error : '获取任务状态失败');

                        if (typeof jd.progress === 'number') {
                            showStatus(`处理中… ${jd.progress}%`, 'info');
                        } else if (jd.message) {
                            showStatus(jd.message, 'info');
                        }

                        if (Array.isArray(jd.log_tail) && jd.log_tail.length > 0) {
                            // 将日志尾部展示在结果区域（不影响最终文本）
                            const logText = jd.log_tail.join('\n');
                            if (logText !== lastLog) {
                                lastLog = logText;
                                // 如果转写文本尚为空，则先显示日志；完成后会被结果覆盖
                                if (!resultText.textContent) {
                                    resultText.textContent = logText;
                                }
                            }
                        }

                        if (jd.status === 'done') {
                            resultText.textContent = jd.text || '';
                            const duration = jd.transcribe_duration;
                            let durationMsg = '转写完成';
                            if (duration !== undefined && duration !== null) {
                                const seconds = Math.round(duration);
                                const minutes = Math.floor(seconds / 60);
                                const secs = seconds % 60;
                                if (minutes > 0) {
                                    durationMsg += `（耗时：${minutes}分${secs}秒）`;
                                } else {
                                    durationMsg += `（耗时：${seconds}秒）`;
                                }
                            }
                            durationMsg += '（文本已自动保存到 survey/ 目录）';
                            showStatus(durationMsg, 'success');
                            stopPolling();
                            transcribeBtn.disabled = false;
                            transcribeBtn.textContent = '开始转文字';
                            bundleBtn.disabled = false;
                            setTranscriptActionsEnabled(!!getTranscriptText());
                            return;
                        }
                        if (jd.status === 'error') {
                            showStatus(jd.message || '转写失败', 'error');
                            stopPolling();
                            transcribeBtn.disabled = false;
                            transcribeBtn.textContent = '开始转文字';
                            bundleBtn.disabled = true;
                            setTranscriptActionsEnabled(false);
                            return;
                        }
                        // queued / running：上面已处理 message/progress
                    } catch (e) {
                        showStatus('轮询失败：' + (e && e.message ? e.message : 'unknown'), 'error');
                        stopPolling();
                        transcribeBtn.disabled = false;
                        transcribeBtn.textContent = '开始转文字';
                    }
                }, 1500);
            } catch (e) {
                showStatus('提交失败：' + (e && e.message ? e.message : 'unknown'), 'error');
                transcribeBtn.disabled = false;
                transcribeBtn.textContent = '开始转文字';
                bundleBtn.disabled = true;
            }
        });

        bundleBtn.addEventListener('click', async () => {
            if (!currentJobId) {
                showStatus('请先完成一次转写', 'error');
                return;
            }
            const docxFile = docxInput.files && docxInput.files[0] ? docxInput.files[0] : null;
            if (!docxFile) {
                showStatus('请先选择一个 .docx 提纲文件', 'error');
                return;
            }

            try {
                bundleBtn.disabled = true;
                showStatus('正在生成 bundle.json（questions + transcript）...', 'info');
                const form = new FormData();
                form.append('job_id', currentJobId);
                form.append('docx', docxFile, docxFile.name);

                const resp = await fetch('/api/bundle', { method: 'POST', body: form });
                if (!resp.ok) {
                    const data = await resp.json().catch(() => ({}));
                    throw new Error(data && data.error ? data.error : '生成 bundle 失败');
                }
                const blob = await resp.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bundle-${currentJobId}.json`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                showStatus('已生成 bundle.json（已下载）', 'success');
            } catch (e) {
                showStatus('生成失败：' + (e && e.message ? e.message : 'unknown'), 'error');
            } finally {
                bundleBtn.disabled = false;
            }
        });

        // 清空
        clearBtn.addEventListener('click', () => {
            audioFile = null;
            audioElement.src = '';
            audioPlayer.style.display = 'none';
            resultText.textContent = '';
            resultArea.style.display = 'none';
            transcribeBtn.disabled = true;
            bundleBtn.disabled = true;
            setTranscriptActionsEnabled(false);
            fileInput.value = '';
            stopPolling();
            lastLog = '';
            showStatus('已清空', 'info');
        });

        copyTranscriptBtn.addEventListener('click', async () => {
            const text = getTranscriptText();
            if (!text) {
                showStatus('没有可复制的转写文本（请先完成转写）', 'error');
                return;
            }
            try {
                await copyToClipboard(text);
                showStatus('已复制到剪贴板', 'success');
            } catch (e) {
                showStatus('复制失败：' + (e && e.message ? e.message : 'unknown'), 'error');
            }
        });

        downloadTranscriptBtn.addEventListener('click', () => {
            const text = getTranscriptText();
            if (!text) {
                showStatus('没有可导出的转写文本（请先完成转写）', 'error');
                return;
            }
            const baseName = audioFile && audioFile.name ? audioFile.name.replace(/\.[^/.]+$/, '') : 'transcript';
            const suffix = currentJobId ? `-${currentJobId}` : '';
            downloadTextAsFile(text, `${baseName}${suffix}.txt`);
            showStatus('已导出转写 .txt', 'success');
        });

        formatTranscriptBtn.addEventListener('click', async () => {
            if (!backendReady) {
                showStatus('本地服务未就绪：请先运行 python backend/app.py', 'error');
                return;
            }
            const text = getTranscriptText();
            if (!text) {
                showStatus('没有可格式化的文本（请先完成转写）', 'error');
                return;
            }
            try {
                setFormatLoading(true);
                showStatus('正在调用大模型格式化对话…', 'info');
                const resp = await fetch('/api/llm/format', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ transcript: text })
                });
                const data = await resp.json().catch(() => ({}));
                if (!resp.ok) {
                    throw new Error(data && data.error ? data.error : '调用失败');
                }
                const formatted = (data.formatted || '').trim();
                if (!formatted) {
                    throw new Error('格式化结果为空');
                }
                resultText.textContent = formatted;
                resultArea.style.display = 'block';
                setTranscriptActionsEnabled(true);
                let msg = '格式化完成';
                const fd = data.format_duration;
                if (fd !== undefined && fd !== null) {
                    const seconds = Math.round(fd);
                    const minutes = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    if (minutes > 0) {
                        msg += `（耗时：${minutes}分${secs}秒）`;
                    } else {
                        msg += `（耗时：${seconds}秒）`;
                    }
                }
                if (data.finish_reason) {
                    msg += `，finish_reason=${data.finish_reason}`;
                }
                showStatus(msg, 'success');
            } catch (e) {
                showStatus('格式化失败：' + (e && e.message ? e.message : 'unknown'), 'error');
            } finally {
                setFormatLoading(false);
            }
        });

        // 页面加载：检测后端
        checkBackend();

        // 仅用于展示文件名（不影响原有逻辑：仍以 input.files 为准）
        function updateFileNameLabel(inputEl, nameEl) {
            try {
                if (!inputEl || !nameEl) return;
                const f = inputEl.files && inputEl.files[0] ? inputEl.files[0] : null;
                nameEl.textContent = f ? f.name : '未选择文件';
            } catch (e) {}
        }
        if (transcriptTxtInput) {
            transcriptTxtInput.addEventListener('change', () => updateFileNameLabel(transcriptTxtInput, transcriptTxtName));
            updateFileNameLabel(transcriptTxtInput, transcriptTxtName);
        }
        if (questionsTxtInput) {
            questionsTxtInput.addEventListener('change', () => updateFileNameLabel(questionsTxtInput, questionsTxtName));
            updateFileNameLabel(questionsTxtInput, questionsTxtName);
        }

        async function readFileAsText(file) {
            return await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(String(reader.result || ''));
                reader.onerror = reject;
                reader.readAsText(file, 'utf-8');
            });
        }

        function setFormatLoading(isLoading) {
            if (isLoading) {
                formatTranscriptBtn.disabled = true;
                formatTranscriptBtn.classList.add('btn-loading');
                formatTranscriptBtn.textContent = '格式化中...';
                copyTranscriptBtn.disabled = true;
                downloadTranscriptBtn.disabled = true;
            } else {
                formatTranscriptBtn.disabled = !getTranscriptText();
                formatTranscriptBtn.classList.remove('btn-loading');
                formatTranscriptBtn.textContent = '格式化文本';
                const enabled = !!getTranscriptText();
                copyTranscriptBtn.disabled = !enabled;
                downloadTranscriptBtn.disabled = !enabled;
            }
        }

        function setMatchLoading(isLoading) {
            if (isLoading) {
                runMatchBtn.disabled = true;
                runMatchBtn.classList.add('btn-loading');
                downloadMatchBtn.disabled = true;
                let base = '匹配中';
                runMatchBtn.textContent = base + '...';
                matchLoadingDots = 0;
                if (matchLoadingTimer) clearInterval(matchLoadingTimer);
                matchLoadingTimer = setInterval(() => {
                    matchLoadingDots = (matchLoadingDots + 1) % 4;
                    runMatchBtn.textContent = base + '.'.repeat(matchLoadingDots);
                }, 400);
            } else {
                if (matchLoadingTimer) {
                    clearInterval(matchLoadingTimer);
                    matchLoadingTimer = null;
                }
                runMatchBtn.disabled = false;
                runMatchBtn.classList.remove('btn-loading');
                runMatchBtn.textContent = '开始匹配';
            }
        }

        runMatchBtn.addEventListener('click', async () => {
            if (!backendReady) {
                showStatus('本地服务未就绪：请先运行 python backend/app.py', 'error');
                return;
            }
            const transcriptFile = transcriptTxtInput.files && transcriptTxtInput.files[0] ? transcriptTxtInput.files[0] : null;
            const questionsFile = questionsTxtInput.files && questionsTxtInput.files[0] ? questionsTxtInput.files[0] : null;

            if (!transcriptFile) {
                showStatus('请选择 录音.txt（转写文本）', 'error');
                return;
            }
            if (!questionsFile) {
                showStatus('请选择 questions.txt（问题模板）', 'error');
                return;
            }

            try {
                setMatchLoading(true);
                matchArea.style.display = 'none';
                matchText.textContent = '';
                showStatus('正在调用大模型匹配中…（可能需要几十秒）', 'info');

                const transcript = await readFileAsText(transcriptFile);
                const questions = await readFileAsText(questionsFile);

                const resp = await fetch('/api/llm/match', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ transcript, questions })
                });
                const data = await resp.json().catch(() => ({}));
                if (!resp.ok) {
                    throw new Error(data && data.error ? data.error : '调用失败');
                }

                lastMatchContent = data.cleaned || data.content || '';
                matchText.textContent = lastMatchContent || '';
                matchArea.style.display = 'block';
                downloadMatchBtn.disabled = false;
                const fr = data.finish_reason ? `，finish_reason=${data.finish_reason}` : '';
                const matchDuration = data.match_duration;
                let matchMsg = '匹配完成';
                if (matchDuration !== undefined && matchDuration !== null) {
                    const seconds = Math.round(matchDuration);
                    const minutes = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    if (minutes > 0) {
                        matchMsg += `（耗时：${minutes}分${secs}秒）`;
                    } else {
                        matchMsg += `（耗时：${seconds}秒）`;
                    }
                }
                matchMsg += fr;
                showStatus(matchMsg, 'success');
            } catch (e) {
                showStatus('匹配失败：' + (e && e.message ? e.message : 'unknown'), 'error');
            } finally {
                setMatchLoading(false);
            }
        });

        downloadMatchBtn.addEventListener('click', () => {
            if (!lastMatchContent) {
                showStatus('没有可下载的结果', 'error');
                return;
            }
            const blob = new Blob([lastMatchContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'qa_match_result.txt';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>